<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Camera & Map Viewer</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; overscroll-behavior:none; }
    #app{position:relative;width:100vw;height:100vh;overflow:hidden;}
    #videoContainer{position:relative;width:100%;height:100%;overflow:hidden;}
    #video{width:100%;height:100%;object-fit:cover;}
    #map{position:absolute;bottom:1rem;right:1rem;width:30vw;height:20vh;min-width:150px;min-height:120px;border:2px solid #fff;border-radius:8px;overflow:hidden;z-index:20;}
    #geoInfo{position:absolute;bottom:1rem;left:1rem;background:rgba(0,0,0,.4);padding:.4rem .6rem;border-radius:8px;font-size:.85rem;line-height:1.25;z-index:20;pointer-events:none;}
    #eventSelector{position:absolute;top:5%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:.5rem 1rem;border-radius:10px;z-index:25;color:#fff;font-size:1.5rem;font-weight:bold;text-align:center;}
    #eventSelector select{background:transparent;color:#fff;font-size:1.75rem;border:none;outline:none;appearance:none;}
    #hailSizeSelector{position:absolute;top:12%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:.5rem 1rem;border-radius:10px;z-index:25;color:#fff;font-size:1.25rem;font-weight:bold;text-align:center;display:none;}
    #hailSizeSelector select{background:transparent;color:#fff;font-size:1.25rem;border:none;outline:none;appearance:none;}
    #captureBtn{position:absolute;bottom:6%;left:50%;transform:translateX(-50%);width:70px;height:70px;border:4px solid #fff;border-radius:50%;background:rgba(255,255,255,.2);z-index:25;cursor:pointer;}
    #captureBtn:active{background:rgba(255,255,255,.4);} 
    #snapshot{position:absolute;inset:0;background:rgba(0,0,0,.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:40;}
    #snapshot img{max-width:90%;max-height:80%;border:4px solid #fff;border-radius:8px;}
    #snapshot button{margin-top:1rem;padding:.5rem 1rem;font-size:1rem;border:none;border-radius:6px;background:#fff;cursor:pointer;}
    #loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:30;}
  </style>
</head>
<body>
  <div id="app">
    <div id="videoContainer">
      <video id="video" autoplay playsinline muted></video>
      <div id="loader">Loading camera…</div>
    </div>

    <div id="map"></div>
    <div id="geoInfo">Locating…</div>

    <!-- Main event selector -->
    <div id="eventSelector">
      <label for="eventType">Event: </label>
      <select id="eventType">
        <option value="Tornado">Tornado</option>
        <option value="Funnel Cloud">Funnel Cloud</option>
        <option value="Wall Cloud">Wall Cloud</option>
        <option value="Hail">Hail</option>
        <option value="Damage">Damage</option>
      </select>
    </div>

    <!-- Hail size sub‑menu -->
    <div id="hailSizeSelector">
      <label for="hailSize">Size: </label>
      <select id="hailSize">
        <option value="">Select size</option>
        <option value="Pea (0.25″)">Pea (0.25″)</option>
        <option value="Nickel (0.88″)">Nickel (0.88″)</option>
        <option value="Quarter (1.00″)">Quarter (1.00″)</option>
        <option value="Golf Ball (1.75″)">Golf Ball (1.75″)</option>
        <option value="Hen Egg (2.00″)">Hen Egg (2.00″)</option>
        <option value="Tennis Ball (2.50″)">Tennis Ball (2.50″)</option>
        <option value="Baseball (2.75″)">Baseball (2.75″)</option>
        <option value="Softball (4.00″)">Softball (4.00″)</option>
      </select>
    </div>

    <button id="captureBtn" title="Take Photo"></button>

    <div id="snapshot">
      <img id="snapshotImg" src="" alt="Captured photo" />
      <button id="closeSnap">Close</button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  /* ==== CAMERA + SNAPSHOT SETUP ==== */
  let imageCapture;
  const CONSTRAINTS = {
    video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30, max: 60 } },
    audio: false
  };

  async function startCamera() {
    const loader = document.getElementById('loader');
    try {
      const stream = await navigator.mediaDevices.getUserMedia(CONSTRAINTS);
      const video = document.getElementById('video');
      video.srcObject = stream;
      await video.play();
      const [track] = stream.getVideoTracks();
      if ('ImageCapture' in window) {
        imageCapture = new ImageCapture(track);
      }
    } catch (err) {
      alert('Unable to access camera: ' + err.message);
    } finally {
      loader.style.display = 'none';
    }
  }

  function capturePhoto() {
    const overlay = document.getElementById('snapshot');
    const imgEl = document.getElementById('snapshotImg');
    const show = (url) => {
      imgEl.src = url;
      overlay.style.display = 'flex';
    };

    if (imageCapture) {
      imageCapture.takePhoto().then(blob => {
        show(URL.createObjectURL(blob));
      }).catch(() => fallback());
    } else {
      fallback();
    }

    function fallback() {
      const v = document.getElementById('video');
      const c = document.createElement('canvas');
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      const ctx = c.getContext('2d');
      ctx.drawImage(v, 0, 0);
      c.toBlob(blob => show(URL.createObjectURL(blob)), 'image/jpeg', 0.92);
    }
  }

  /* ==== MAP & GEO + NWS API ==== */
  async function fetchNwsInfo(lat, lon) {
    const info = document.getElementById('geoInfo');
    try {
      const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
      if (!response.ok) throw new Error(`NWS API error: ${response.status}`);
      const data = await response.json();
      // Extract city, county, and WFO name from properties
      const city = data.properties.relativeLocation.properties.city || 'Unknown city';
      const county = data.properties.relativeLocation.properties.county || 'Unknown county';
      const wfo = data.properties.cwa || 'Unknown WFO';
      info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | City: ${city}, County: ${county}, WFO: ${wfo}`;
    } catch (err) {
      info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | NWS API error: ${err.message}`;
    }
  }

  function initMap() {
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const info = document.getElementById('geoInfo');
    const fix = () => map.invalidateSize();
    window.addEventListener('resize', fix);
    window.addEventListener('orientationchange', fix);

    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const { latitude: lat, longitude: lon, accuracy } = pos.coords;
          map.setView([lat, lon], 15);
          L.marker([lat, lon]).addTo(map);
          if (accuracy) {
            L.circle([lat, lon], { radius: accuracy, color: '#3388ff', weight: 1 }).addTo(map);
          }
          await fetchNwsInfo(lat, lon);
          fix();
        },
        (err) => {
          info.textContent = 'Geolocation error: ' + err.message;
          map.setView([20, 0], 2);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } else {
      info.textContent = 'Geolocation not supported.';
      map.setView([20, 0], 2);
    }
  }

  /* ==== HAIL SIZE MENU LOGIC ==== */
  function setupEventMenus() {
    console.log("setupEventMenus called");

    const eventSel = document.getElementById('eventType');
    const hailMenu = document.getElementById('hailSizeSelector');

    function toggle() {
      console.log("toggle called");
      const selected = eventSel.value.toLowerCase();
      console.log("Selected event:", selected);
      if (selected === 'hail') {
        hailMenu.style.display = 'block';
      } else {
        hailMenu.style.display = 'none';
        document.getElementById('hailSize').value = '';
      }
    }

    eventSel.addEventListener('change', toggle);
    toggle(); // run once on load
  }

  /* ==== INIT ==== */
  window.addEventListener('load', () => {
    startCamera();
    initMap();
    setupEventMenus();

    document.getElementById('captureBtn').addEventListener('click', capturePhoto);
    document.getElementById('closeSnap').addEventListener('click', () => {
      document.getElementById('snapshot').style.display = 'none';
    });
  });
</script>

</body>
</html>
