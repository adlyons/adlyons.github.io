<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Camera & Map Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; overscroll-behavior:none; }
    #app{position:relative;width:100vw;height:100vh;overflow:hidden;}
    #videoContainer{position:relative;width:100%;height:100%;overflow:hidden;z-index:10;}
    #video{width:100%;height:100%;object-fit:cover;}
    #map{position:absolute;bottom:0.25rem;right:0.25rem;width:30vw;height:20vh;min-width:150px;min-height:120px;border:2px solid #fff;border-radius:8px;overflow:hidden;z-index:20;}
    #geoInfo {
      position:absolute;
      bottom:22vh; /* above map */
      left:1rem;
      background:rgba(0,0,0,.6);
      padding:.4rem .6rem;
      border-radius:8px;
      font-size:.85rem;
      line-height:1.25;
      z-index:30;
      pointer-events:none;
      max-width:30vw;
      min-width:150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #eventSelector{position:absolute;top:5%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:.5rem 1rem;border-radius:10px;z-index:25;color:#fff;font-size:1.5rem;font-weight:bold;text-align:center;}
    #eventSelector select{background:transparent;color:#fff;font-size:1.75rem;border:none;outline:none;appearance:none;}
    #hailSizeSelector{position:absolute;top:15%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:.5rem 1rem;border-radius:10px;z-index:25;color:#fff;font-size:1.25rem;font-weight:bold;text-align:center;display:none;}
    #hailSizeSelector select{background:transparent;color:#fff;font-size:1.25rem;border:none;outline:none;appearance:none;}
    #captureBtn{position:absolute;bottom:6%;left:50%;transform:translateX(-50%);width:70px;height:70px;border:4px solid #fff;border-radius:50%;background:rgba(255,255,255,.2);z-index:25;cursor:pointer;}
    #captureBtn:active{background:rgba(255,255,255,.4);} 
    #snapshot{position:absolute;inset:0;background:rgba(0,0,0,.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:40;}
    #snapshot img{max-width:90%;max-height:80%;border:4px solid #fff;border-radius:8px;}
    #snapshot button{margin-top:1rem;padding:.5rem 1rem;font-size:1rem;border:none;border-radius:6px;background:#fff;cursor:pointer;}
    #loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:30;}

    #tweetPanel {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.95);
      color: #fff;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: right 0.3s ease;
      }
    #tweetPanel.open {
      right: 0;
    }
    #tweetContent {
      max-width: 90vw;
      text-align: center;
    }
  #tweetText {
    width: 90vw;
    height: 30vh;
    font-size: 1rem;
    padding: 1rem;
    background: #111;
    color: #0f0;
    border: 1px solid #888;
    border-radius: 10px;
    resize: none;
    margin-bottom: 1rem;
  }
  #tweetPanel button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    background: #fff;
    color: #000;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  </style>
</head>
<body>
  <div id="app">
    <div id="videoContainer">
      <video id="video" autoplay playsinline muted></video>
      <div id="loader">Loading camera…</div>
    </div>

    <div id="map"></div>
    <div id="geoInfo">Locating…</div>

    <div id="eventSelector">
      <select id="eventType" aria-label="Event Type">
        <option value="Tornado"></option>
        <option value="Tornado">Tornado</option>
        <option value="Funnel Cloud">Funnel Cloud</option>
        <option value="Wall Cloud">Wall Cloud</option>
        <option value="Hail">Hail</option>
        <option value="Damage">Damage</option>
      </select>
    </div>

    <div id="hailSizeSelector">
      <label for="hailSize">Size: </label>
      <select id="hailSize">
        <option value="">Select size</option>
        <option value="Pea (0.25″)">Pea (0.25″)</option>
        <option value="Nickel (0.88″)">Nickel (0.88″)</option>
        <option value="Quarter (1.00″)">Quarter (1.00″)</option>
        <option value="Golf Ball (1.75″)">Golf Ball (1.75″)</option>
        <option value="Hen Egg (2.00″)">Hen Egg (2.00″)</option>
        <option value="Tennis Ball (2.50″)">Tennis Ball (2.50″)</option>
        <option value="Baseball (2.75″)">Baseball (2.75″)</option>
        <option value="Softball (4.00″)">Softball (4.00″)</option>
      </select>
    </div>

    <button id="captureBtn" title="Take Screenshot"></button>

    <div id="snapshot">
      <img id="snapshotImg" src="" alt="Captured photo" />
      <button id="closeSnap">Close</button>
    </div>

    <div id="tweetPanel">
      <div id="tweetContent">
      <h3>Share Report</h3>
      <textarea id="tweetText" readonly></textarea>
      <button onclick="copyTweet()">Copy Tweet</button>
    </div>
</div>

  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let map;
    let mapNeedsRedraw = false;

    function headingToCompass(deg) {
      if (deg === null || deg === undefined || isNaN(deg)) return 'Unknown';
      const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW', 'N'];
      return directions[Math.round(deg / 45) % 8];
    }

    /* ==== CAMERA SETUP ==== */
    const CONSTRAINTS = {
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30, max: 60 } },
      audio: false
    };

    async function startCamera() {
      const loader = document.getElementById('loader');
      try {
        const stream = await navigator.mediaDevices.getUserMedia(CONSTRAINTS);
        const video = document.getElementById('video');
        video.srcObject = stream;
        await video.play();
      } catch (err) {
        alert('Unable to access camera: ' + err.message);
      } finally {
        loader.style.display = 'none';
      }
    }

    /* ==== SCREENSHOT USING HTML2CANVAS ==== */
    async function capturePhoto() {
      const overlay = document.getElementById('snapshot');
      const imgEl = document.getElementById('snapshotImg');

      // Capture the entire #app div (video, map, UI)
      try {
        const canvas = await html2canvas(document.getElementById('app'), { backgroundColor: null, useCORS: true, logging: false });
        imgEl.src = canvas.toDataURL('image/png');
        overlay.style.display = 'flex';
      } catch (err) {
        alert('Screenshot capture failed: ' + err.message);
      }

      // Redraw map after screenshot to fix black tiles
      if (mapNeedsRedraw) {
        map.invalidateSize();
        mapNeedsRedraw = false;
      }
    }

    /* ==== MAP & GEO + NWS API ==== */
    async function fetchNwsInfo(lat, lon, heading) {
      const info = document.getElementById('geoInfo');
      try {
        const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
        if (!response.ok) throw new Error(`NWS API error: ${response.status}`);
        const data = await response.json();

        let city = data.properties.relativeLocation?.properties?.city || 'Unknown city';
        let county = data.properties.relativeLocation?.properties?.county || '';
        if (!county) {
          county = 'Unknown county';
        }
        const wfo = data.properties.cwa || 'Unknown WFO';

        let headingText = heading !== null ? `, Heading: ${heading}° (${headingToCompass(heading)})` : '';

        info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | City: ${city}, County: ${county}, WFO: ${wfo}${headingText}`;
      } catch (err) {
        info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | NWS API error: ${err.message}`;
      }
    }

    function initMap() {
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      const info = document.getElementById('geoInfo');
      const fix = () => map.invalidateSize();
      window.addEventListener('resize', fix);
      window.addEventListener('orientationchange', fix);

      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(
          async (pos) => {
            const { latitude: lat, longitude: lon, accuracy, heading } = pos.coords;
            map.setView([lat, lon], 10);

            // Remove old markers/circles before adding new ones
            map.eachLayer(layer => {
              if (layer instanceof L.Marker || layer instanceof L.Circle) {
                map.removeLayer(layer);
              }
            });

            L.marker([lat, lon]).addTo(map);
            if (accuracy) {
              L.circle([lat, lon], { radius: accuracy, color: '#3388ff', weight: 1 }).addTo(map);
            }

            await fetchNwsInfo(lat, lon, heading);

            fix();

            mapNeedsRedraw = true;
          },
          (err) => {
            info.textContent = 'Geolocation error: ' + err.message;
            map.setView([20, 0], 2);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        info.textContent = 'Geolocation not supported.';
        map.setView([20, 0], 2);
      }
    }

    /* ==== HAIL SIZE MENU LOGIC ==== */
    function setupEventMenus() {
      const eventSel = document.getElementById('eventType');
      const hailMenu = document.getElementById('hailSizeSelector');

      function toggle() {
        const selected = eventSel.value.toLowerCase();
        if (selected === 'hail') {
          hailMenu.style.display = 'block';
        } else {
          hailMenu.style.display = 'none';
          document.getElementById('hailSize').value = '';
        }
      }

      eventSel.addEventListener('change', toggle);
      toggle();
    }

    window.addEventListener('load', () => {
      startCamera();
      initMap();
      setupEventMenus();

      document.getElementById('captureBtn').addEventListener('click', capturePhoto);
      document.getElementById('closeSnap').addEventListener('click', () => {
        document.getElementById('snapshot').style.display = 'none';
      });
    });



    let tweetInfo = {
      wfo: 'NWS',
      event: 'Tornado',
      city: '',
      county: '',
      lat: '',
      lon: '',
      timestamp: '',
    };

    // Swipe logic
    let touchStartX = null;
    document.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].clientX;
    });
    document.addEventListener('touchend', (e) => {
      if (touchStartX !== null) {
        const dx = e.changedTouches[0].clientX - touchStartX;
        if (dx < -100) {
          // swipe left
          showTweetPanel();
        }
        touchStartX = null;
      }
    });

    function showTweetPanel() {
      const tweetBox = document.getElementById('tweetText');
      const now = new Date();
      tweetInfo.timestamp = now.toLocaleString();

      const tweet = `@${tweetInfo.wfo} ${tweetInfo.event} reported near ${tweetInfo.city || 'Unknown'}, ${tweetInfo.county || ''} (Lat: ${tweetInfo.lat}, Lon: ${tweetInfo.lon}) at ${tweetInfo.timestamp}. #wx`;
      tweetBox.value = tweet;

      document.getElementById('tweetPanel').classList.add('open');
    }

    function copyTweet() {
      const tweet = document.getElementById('tweetText');
      tweet.select();
      document.execCommand('copy');
      alert('Tweet copied to clipboard!');
    }

    // Update info from fetchNwsInfo
    async function fetchNwsInfo(lat, lon, heading) {
      const info = document.getElementById('geoInfo');
      try {
        const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`);
        if (!response.ok) throw new Error(`NWS API error: ${response.status}`);
        const data = await response.json();

        let city = data.properties.relativeLocation?.properties?.city || 'Unknown city';
        let county = data.properties.relativeLocation?.properties?.county || 'Unknown county';
        const wfo = data.properties.cwa || 'NWS';

        tweetInfo = { ...tweetInfo, lat: lat.toFixed(5), lon: lon.toFixed(5), city, county, wfo: `NWS${wfo}` };

        let headingText = heading !== null ? `, Heading: ${heading}° (${headingToCompass(heading)})` : '';
        info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | City: ${city}, County: ${county}, WFO: ${wfo}${headingText}`;
      } catch (err) {
        info.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)} | NWS API error: ${err.message}`;
      }
    }

    // Also update event type when selected
    document.getElementById('eventType')?.addEventListener('change', e => {
      tweetInfo.event = e.target.value;
    });

  </script>
</body>
</html>
